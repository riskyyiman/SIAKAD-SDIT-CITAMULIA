generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  Admin
  Guru
  Wali
}

model Users {
  id_user    Int      @id @default(autoincrement())
  username   String   @unique @db.VarChar(50)
  password   String   @db.VarChar(255)
  nama       String   @db.VarChar(100)
  role       Role

  guru       Guru?
  siswa_akun Siswa?   @relation("AkunSiswa")
  siswa_anak Siswa[]  @relation("AkunOrangTua")
}

model Guru {
  nip          String  @id @db.VarChar(20)
  id_user      Int     @unique
  nama         String  @db.VarChar(100)
  no_hp        String  @db.VarChar(15)
  spesialisasi String  @db.VarChar(50)
  
  user         Users   @relation(fields: [id_user], references: [id_user], map: "fk_guru_user")
  kelas_wali   Kelas[] @relation("WaliKelas")
  mapel_diampu Mapel[] 
}

model Kelas {
  id_kelas      Int      @id @default(autoincrement())
  wali_kelas_id String?  @db.VarChar(20)
  nama_kelas    String   @db.VarChar(10)
  tahun_ajaran  String   @db.VarChar(10)

  // Tambahkan map: "fk_kelas_wali" untuk menghindari bentrok nama
  wali_kelas    Guru?    @relation("WaliKelas", fields: [wali_kelas_id], references: [nip], map: "fk_kelas_wali_guru")
  
  siswa         Siswa[]
  mapel_kelas   MapelKelas[]
}

model Mapel {
  kode_mapel  String   @id @db.VarChar(10)
  nama_mapel  String   @db.VarChar(50)
  nip_guru    String?  @db.VarChar(20)

  // Tambahkan map: "fk_mapel_guru"
  guru        Guru?    @relation(fields: [nip_guru], references: [nip], map: "fk_mapel_guru")
  
  nilai       Nilai[]
  mapel_kelas MapelKelas[]
}

model MapelKelas {
  id_mapel_kelas Int    @id @default(autoincrement())
  id_kelas       Int
  id_mapel       String @db.VarChar(10)

  // Tambahkan map unik juga disini
  kelas          Kelas  @relation(fields: [id_kelas], references: [id_kelas], onDelete: Cascade, map: "fk_mk_kelas")
  mapel          Mapel  @relation(fields: [id_mapel], references: [kode_mapel], onDelete: Cascade, map: "fk_mk_mapel")

  @@unique([id_kelas, id_mapel])
}

model Siswa {
  nis       String    @id @db.VarChar(20)
  id_user   Int?      @unique 
  id_kelas  Int
  nama      String    @db.VarChar(100)
  tgl_lahir DateTime  @db.Date
  alamat    String    @db.Text
  id_ortu   Int?      

  user      Users?    @relation("AkunSiswa", fields: [id_user], references: [id_user], map: "fk_siswa_user")
  ortu      Users?    @relation("AkunOrangTua", fields: [id_ortu], references: [id_user], map: "fk_siswa_ortu")
  kelas     Kelas     @relation(fields: [id_kelas], references: [id_kelas], map: "fk_siswa_kelas")
  nilai     Nilai[]
  absensi   Absensi[]
}

model Nilai {
  id_nilai    Int      @id @default(autoincrement())
  id_siswa    String   @db.VarChar(20)
  id_mapel    String   @db.VarChar(10)
  nilai_tugas Int
  nilai_uts   Int
  nilai_uas   Int
  grade       String   @db.Char(1)

  siswa       Siswa    @relation(fields: [id_siswa], references: [nis], map: "fk_nilai_siswa")
  mapel       Mapel    @relation(fields: [id_mapel], references: [kode_mapel], map: "fk_nilai_mapel")
}

model Absensi {
  id_absensi  Int      @id @default(autoincrement())
  id_siswa    String   @db.VarChar(20)
  tanggal     DateTime @db.Date
  status      StatusAbsensi
  keterangan  String?  @db.Text

  siswa       Siswa    @relation(fields: [id_siswa], references: [nis], map: "fk_absensi_siswa")
}

enum StatusAbsensi {
  Hadir
  Sakit
  Izin
  Alpha
}